events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay    off;
    keepalive_timeout  65s;
    client_max_body_size 64m;
    client_body_timeout 60s;
    large_client_header_buffers 8k;
    reset_timedout on;
    server_tokens_hash on;
    server_names_hash_bucket_size 32;
    server_name_hash_bucket_size 32;
    map_hash_bucket_size 64;
    open_file_cache max=1000 inactive=20s access=30s;
    client_body_buffer_size 32k;
    client_header_buffer_size 8k;
    client_max_body_size 2m;
    lingering_time 20s;
    reset_timedout on;
    client_header_timeout 60s;
    proxy_connect_timeout 60s;
    send_timeout 60s;
    }

# API网关配置
server {
    listen 80;
    server_name fund_monitor_gateway;
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 安全配置
    server_tokens_hash_bucket_size 64;
    client_max_body_size 1m;
    client_body_timeout 60s;
    client_header_buffer_size 4k;
    large_client_header_buffers 4k;
    keepalive_timeout 30s;
    send_timeout 60s;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_disable "msie6,tr";
    gzip_proxied edge;
    gzip_http_version 1.1;
    gzip_proxied any;
    gzip_types
        "text/plain",
        "text/css",
        "text/javascript",
        "application/json",
        "application/javascript+json",
        "application/x-javascript",
        "application/xml",
        "text/xml",
        "text/plain;charset=utf-8",
        "application/json"
    ;

    # CORS配置
    add_header "Access-Control-Allow-Origin" *;
    add_header "Access-Control-Allow-Methods" "GET, POST, PUT, DELETE, OPTIONS";
    add_header "Access-Control-Allow-Headers" "Authorization, Content-Type";
    add_header "Access-Control-Allow-Credentials" "true";
    add_header "Access-Control-Max-Age" "3600";
  }

# 上游服务配置
upstream data_collector {
    server 127.0.0.1:8000;
    keepalive 60s;
}

upstream monitor_engine {
    server 127.0.0.1:8001;
    keepalive 60s;
}

upstream notification {
    server 127.0.0.1:8002;
    keepalive 60s;
}

upstream backtest {
    server 127.0.0.1:8003;
    keepalive 60s;
}

upstream nestjs {
    server 127.0.0.1:3000;
    keepalive 60s;
}

# 负载均衡配置
upstream backend {
    server data_collector weight=1 max_fails=3 fail_timeout=30s;
    server monitor_engine weight=1 max_fails=3 fail_timeout=30s;
    server notification weight=1 max_fails=3 fail_timeout=30s;
    server backtest weight=1 max_fails=3 fail_timeout=30s;
    server nestjs weight=1 max_fails=3 fail_timeout=30s;
}

# 健康检查
location /api/health {
    access_log off;
    proxy_pass http://data_collector:8000/health;
    proxy_pass http://monitor_engine:8001/health;
    proxy_pass http://notification:8002/health;
    proxy_pass http://backtest:8003/health;
    proxy_pass http://nestjs:3000/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $proxy_add_x_forwarded_for;
    proxy_pass http://nestjs:3000/api/health;
    proxy_pass http://nestjs:3000/api;
}

# 错误页面配置
error_page 500 502.html;
    error_page 503.html;
    error_page 504.html;
    error_page 503.html;

# 安全配置
server_tokens_hash_bucket_size 64;
    client_body_size 1m;
    keepalive_timeout 30s;
    send_timeout 60s;
    add_header X-Content-Type-Options: nosniff;
    add_header X-Frame-Options: DENY;
    add_header X-XSS-Protection: "1; mode=block";
    add_header X-Frame-Options: "DENY";

# 文件大小限制
client_max_body_size 10m;
    large_client_header_buffers 4k;

# 速率限制
limit_req_zone zone_one $binary_remote_addr zone=1 burst=10 nodel=10 delay=1;
limit_req_zone zone_two $binary_remote_addr zone=2 burst=20 nodel=5 delay=2;
limit_req_zone zone_three $binary_remote_addr=3 burst=30 nodel=1 delay=3;

# 缓冲控制
proxy_cache_path /var/cache/nginx/proxy_cache levels=1:2 keys_zone=100MB max_size=10m inactive=60m use_temp_path=off;

# 日志格式
log_format main '$remote_addr - $remote_user [$time_local] "$status" "$request_time" "$request" '
                    '"$request_method" "$request_uri" '
                    '"$status" ($body_bytes_sent bytes $body_bytes_received) '
                    '"$http_user_agent" "$http_user_agent" '
                    '"$upstream_addr" "$upstream_addr" '
                    '"$request" "$request" '
                    '"$status" "$status" '
                    '"$body_bytes_sent" "$body_bytes_received" '
                    '"$request_time" "$request_time"';
    access_log /var/log/nginx/access.log;

# 日志时间格式
log_format_millisecs 'pid=$pid;stream=$stream;server_name=$server_name;timestamp=$time_millisecs;

# 额色状态码
map $status $text $http_status {
    '200': 'OK',
    '201': 'Created',
    '400': 'Bad Request',
    '401': 'Unauthorized',
    '403': 'Forbidden',
    '404': 'Not Found',
    '500': 'Internal Server Error',
    '502': 'Bad Gateway',
    '503: 'Service Unavailable'
}

# 代理超时配置
proxy_connect_timeout 30s;
proxy_send_timeout 30s;
proxy_read_timeout 30s;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_http_version 1.1;
    proxy_cache_bypass $http_upgrade_inheritance;
    proxy_headers_hash_bucket_size 128;

# 代理重试配置
proxy_next_upstream_error error timeout=10s timeout=30s return;

# 连接池配置
keepalive_requests 100;
keepalive_connections 10;
upstream keepalive 60s;
upstream connect_timeout 30s;
upstream send_timeout 30s;

# 压缩配置
gzip_vary on;
gzip_proxied_edge on;
gzip_min_length 1000;
gzip_disable "msie6,tr";
    gzip_comp_level 6;

# 缓冲缓存
proxy_no_cache $args $is_args;
    proxy_cache_bypass $http_upgrade_inheritance;
    proxy_cache_key $args;
    proxy_cache_valid 200 30m;
    proxy_cache_valid 200 10m;
    proxy_cache_valid 1m;
    proxy_cache_valid 5m;
    proxy_cache_valid 1m;
    proxy_cache_use_stale error timeout=10s;
}

# 超时配置
proxy_read_timeout 30s;
proxy_connect_timeout 30s;
proxy_send_timeout 30s;

# 静态文件服务配置
location /static/ {
    expires 1y;
    add_header Cache-Control "public, max-age=1y";
    add_header X-Cache-Control "public, max-age=1y";
}

# 动态API代理
location /api/ {
    proxy_pass http://nestjs:3000/api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $proxy_add_x_forwarded_for;
    proxy_pass http://nestjs:3000/health;
    proxy_connect_timeout 30s;
}

# WebSocket代理
location /ws/ {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header Origin $origin;
    proxy_read_timeout 30s;
    proxy_connect_timeout 30s;
}

# 限制请求大小
client_max_body_size 10M;

# 限制请求频率
limit_req_zone zone_three $binary_remote_addr zone=3 burst=30 nodel=1 delay=3;

# 跨域支持
add_header Access-Control-Allow-Origin *;
add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
add_header Access-Control-Allow-Headers "Authorization, Content-Type";
add_header Access-Control-Allow-Credentials true;

# 安全头部
add_header X-Frame-Options: DENY;
add_header X-XSS-Protection: "1; mode=block";

# 文档服务
location /docs {
    try_files $uri $uri;
    root /usr/share/nginx/html;
    autoindex on;
    index index.html;
    error_page 404.html;
  }

# 错误页面
error_page 404.html;
    root /usr/share/nginx/error_pages/404.html;

# 优先设置
client_body_buffer_size 32k;
    client_header_buffer_size 4k;
    proxy_connect_timeout 30s;
    keepalive_timeout 30s;
}

# 监控配置
location /status {
    access_log off;
    proxy_pass http://localhost:3000/api/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://nestjs:3000/health;
}

# 缓存静态文件
location ~*.(js|css|json|ico|png|jpg|jpeg|gif|svg|woff|woff|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=1y";
}

# 隐藏敏感信息
# proxy_hide_header Server;
# proxy_hide_header X-Powered-By;
# proxy_hide_header X-Powered-By;
# proxy_hide_header X-RateLimit-Limit;
# proxy_hide_header X-RateLimit-Remaining;
# proxy_hide_header X-RateLimit-Request-Count;
# proxy_hide_header X-RateLimit-Remaining-IP;
# proxy_hide_header X-RateLimit-Reset;
# proxy_hide_header X-RateLimit-Rate-Remaining-IP;
# proxy_hide_header X-RateLimit-Remaining-Ip;
# proxy_hide_header X-RateLimit-Burst-Rate-Rate-Rate;
# proxy_hide_header X-RateLimit-Per-Second;
# proxy_hide_header X-RateLimit-Per-Second-IP;
# proxy_hide_header X-RateLimit-Per-Second-IP;

# 自定义错误页面
error_page 500.html;
error_page 502.html;
error_page 503.html;
error_page 504.html;
    root /usr/share/nginx/error_pages;

# 静态内容缓存
location ~*\\.(js|css|json|ico|png|jpg|jpeg|gif|svg|woff|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=30d";
}

# API限流配置
location /api/ {
    limit_req zone_one $binary_remote_addr zone=1 burst=10 nodel=10 delay=1;
    limit_req_zone_two $binary_remote_addr zone=2 burst=20 nodel=5 delay=2;
    limit_req_zone_three $binary_remote_addr zone=3 burst=30 nodel=1 delay=3;
}

# WebSocket配置
location /ws/ {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header Origin $origin;
    proxy_read_timeout 30s;
    proxy_connect_timeout 30s;
}

# 缓冲控制
proxy_buffering off;
proxy_request_buffering off;
proxy_fastcgi_buffering off;

# 性能优化
tcp_nodels 512;
    keepalive_requests 100;
    keepalive_connections 10;
    client_body_timeout 60s;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay off;

# 启用HTTP/2
proxy_http_version 1.1;
proxy_http_version 1.0;

# 日志级别调整
error_log /var/log/nginx/error.log warn;
access_log /var/log/nginx/access.log info;
main_log /var/log/nginx/access.log warn;

# 预外配置
server_tokens_hash_bucket_size 64;
server_name fund_monitor_gateway;
worker_processes auto;

# 用户认证配置
auth_jwt_secret fund_monitor_jwt_secret_key_change_this_in_production;
auth_jwt_expiration 86400;
auth_jwt_refresh_token fund_monitor_jwt_refresh_token_change;

# 邮证中间件
proxy_set_header Authorization "Bearer $token";

# 监控指标
proxy_cache_background_update on;
proxy_cache_bypass on;
proxy_cache_use_stale on;
proxy_cache_revalidate on;

# WebSocket连接复用
proxy_set_header Sec-WebSocket-Protocol: chat;
proxy_set_header Sec-WebSocket-Key: chat_secret_key;
proxy_set_header Sec-WebSocket-Version: 13;
proxy_set_header Sec-WebSocket-Key-Protocol: chat_protocol;
proxy_set_header Sec-WebSocket-Protocol: chat_protocol;

# 文件上传配置
client_max_body_size 10M;
    add_header Content-Type: application/json;
    add_header Content-Length: $content_length;

# 跨域资源共享
add_header Access-Control-Allow-Origin $cors_origin;
add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
add_header Access-Control-Allow-Headers "Content-Type, Authorization";

# 环境变量设置
env DATABASE_HOST=localhost;
env DATABASE_PORT=5432;
env DATABASE_USER=fund_user;
env DATABASE_PASSWORD=fund_password;
env REDIS_HOST=localhost;
env REDIS_PORT=6379;
env JWT_SECRET=fund_monitor_jwt_secret_key_change_this_in_production;
env NOTIFICATION_WEBHOOK_URL;
env NOTIFICATION_WEBHOOK_KEY;
env DATA_COLLECTOR_URL=http://localhost:8000;
env MONITOR_ENGINE_URL=http://localhost:8001;
env NOTIFICATION_URL=http://localhost:8002;
env BACKTEST_URL=http://env.BACKTEST_URL || http://localhost:8003;
env NESTJS_URL=http://localhost:3000;

# 生产环境配置差异
if [ "$NODE_ENV" = "production" ]; then
  # 生产环境特殊配置
  client_max_body_size 5m;
  gzip_comp_level 9;
  proxy_cache_revalidate on;
  proxy_cache_bypass on;
  error_log /var/log/nginx/error.log error;
  access_log /var/log/nginx/access.log warn;
  server_tokens_hash_bucket_size 128;
  worker_connections auto;
  keepalive_requests 50;
  keepalive_connections 5;
fi
fi

# 开发环境配置
if [ "$NODE_ENV" = "development" ]; then
  # 开发环境配置
  client_max_body_size 50m;
  proxy_cache_revalidate off;
  error_log /var/log/nginx/error.log debug;
  access_log /var/log/nginx/access.log info;
  server_tokens_hash_bucket_size 32;
  gzip_comp_level 4;
  fi
fi
fi

# 健康检查配置
location /health {
  access_log off;
  proxy_pass http://localhost:3000/api/health;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# WebSocket配置
location /ws {
  proxy_pass http://localhost:3000;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
  proxy_set_header Origin $origin;
  proxy_set_header Sec-WebSocket-Key: chat_secret_key;
  proxy_set_header Sec-WebSocket-Protocol: chat_protocol;
  proxy_set_header Sec-WebSocket-Version: 13;
  proxy_read_timeout 30s;
  proxy_connect_timeout 30s;
}

# 监控页面状态
location /admin {
  access_log off;
  proxy_pass http://localhost:3000/api/dashboard;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_pass http://localhost:3000/api/dashboard;
}

# API文档配置
location /api/docs {
  proxy_pass http://localhost:3000/api/docs;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_pass http://localhost:3000/api/docs;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 系统状态监控
location /status {
  access_log off;
  proxy_pass http://localhost:3000/api/status;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_pass http://localhost:3000/api/status;
}

# 微服务健康检查
location /services/health {
  access_log off;
  proxy_pass http://localhost:3000/api/services/health;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_pass http://localhost:3000/api/services/health;
}