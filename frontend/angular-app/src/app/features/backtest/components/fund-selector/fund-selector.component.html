<mat-card class="fund-selector">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>account_balance</mat-icon>
      选择基金组合
    </mat-card-title>
    <mat-card-subtitle>选择要回测的基金并配置权重</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <!-- 已选基金列表 -->
    <div class="selected-funds" *ngIf="selectedFunds.length > 0">
      <div class="section-header">
        <h3>已选择基金</h3>
        <div class="weight-summary">
          <span class="weight-text" [class.invalid]="!isValidWeights">
            总权重: {{ formatPercent(totalWeight) }}
          </span>
          <button
            mat-stroked-button
            size="small"
            (click)="normalizeWeights()"
            [disabled]="isValidWeights"
            matTooltip="权重标准化为100%">
            标准化权重
          </button>
        </div>
      </div>

      <div class="funds-grid">
        <mat-card class="fund-card" *ngFor="let fund of selectedFunds">
          <mat-card-header class="fund-header">
            <mat-card-title class="fund-title">
              <div class="fund-info">
                <span class="fund-name">{{ fund.fundName }}</span>
                <span class="fund-code">{{ fund.fundCode }}</span>
              </div>
              <button
                mat-icon-button
                class="remove-btn"
                (click)="removeFund(fund.fundId)"
                matTooltip="移除基金">
                <mat-icon>close</mat-icon>
              </button>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="fund-content">
            <div class="weight-control">
              <mat-form-field appearance="outline" class="weight-field">
                <mat-label>权重</mat-label>
                <input matInput
                       type="number"
                       [(ngModel)]="fund.weight"
                       (input)="updateFundWeight(fund.fundId, $event.target.value)"
                       min="0"
                       max="100"
                       step="0.1">
                <span matSuffix>%</span>
              </mat-form-field>
              <mat-slider
                class="weight-slider"
                [(ngModel)]="fund.weight"
                (input)="updateFundWeight(fund.fundId, $event.value)"
                min="0"
                max="100"
                step="0.1"
                thumbLabel="true">
              </mat-slider>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- 权重警告 -->
      <mat-card class="weight-warning" *ngIf="!isValidWeights">
        <mat-card-content>
          <mat-icon class="warning-icon">warning</mat-icon>
          <span class="warning-text">
            基金权重总和不为100%（当前{{ formatPercent(totalWeight) }}），点击"标准化权重"按钮自动调整。
          </span>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- 空状态 -->
    <div class="empty-state" *ngIf="selectedFunds.length === 0">
      <mat-icon class="empty-icon">account_balance</mat-icon>
      <h3>尚未选择基金</h3>
      <p>点击下方按钮添加基金到回测组合</p>
    </div>

    <!-- 添加基金按钮 -->
    <div class="add-fund-section">
      <button
        mat-raised-button
        color="primary"
        (click)="openAddFundDialog()"
        [disabled]="availableFundsForSelection.length === 0">
        <mat-icon>add</mat-icon>
        添加基金
      </button>
      <span class="available-count" *ngIf="availableFundsForSelection.length > 0">
        还可选择 {{ availableFundsForSelection.length }} 只基金
      </span>
    </div>
  </mat-card-content>
</mat-card>

<!-- 添加基金对话框 -->
<div class="add-fund-dialog-overlay" *ngIf="showAddFundDialog" (click)="closeDialog()">
  <mat-card class="add-fund-dialog" (click)="$event.stopPropagation()">
    <mat-card-header>
      <mat-card-title>添加基金</mat-card-title>
      <button mat-icon-button class="close-btn" (click)="closeDialog()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-card-header>
    <mat-card-content>
      <!-- 基金搜索 -->
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>搜索基金</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput [(ngModel)]="searchTerm" (input)="onSearchChange()">
      </mat-form-field>

      <!-- 基金列表 -->
      <div class="fund-list">
        <mat-radio-group class="fund-options" [(ngModel)]="selectedFundId">
          <mat-radio-button
            *ngFor="let fund of availableFundsForSelection"
            [value]="fund.id"
            class="fund-option">

            <div class="fund-option-content">
              <div class="fund-basic-info">
                <div class="fund-name-line">
                  <span class="fund-name">{{ fund.name }}</span>
                  <mat-chip-list class="fund-type">
                    <mat-chip color="accent" selected>
                      {{ getFundTypeLabel(fund.type) }}
                    </mat-chip>
                  </mat-chip-list>
                </div>
                <div class="fund-meta">
                  <span class="fund-code">{{ fund.code }}</span>
                  <span class="fund-nav">{{ formatCurrency(fund.currentNav) }}</span>
                  <span class="fund-change" [style.color]="getFundTrendInfo(fund).color">
                    {{ getFundTrendInfo(fund).change >= 0 ? '+' : '' }}{{ getFundTrendInfo(fund).change.toFixed(2) }}%
                  </span>
                </div>
              </div>
            </div>
          </mat-radio-button>
        </mat-radio-group>

        <!-- 空状态 -->
        <div class="no-funds" *ngIf="availableFundsForSelection.length === 0">
          <mat-icon>search_off</mat-icon>
          <p>没有可选择的基金</p>
        </div>
      </div>

      <!-- 权重设置 -->
      <div class="weight-section" *ngIf="selectedFundId">
        <mat-form-field appearance="outline" class="weight-field">
          <mat-label>投资权重</mat-label>
          <input matInput
                 type="number"
                 [(ngModel)]="currentWeight"
                 min="0"
                 max="100"
                 step="0.1">
          <span matSuffix>%</span>
          <mat-hint>建议权重不超过 {{ Math.max(0, 100 - totalWeight).toFixed(1) }}%</mat-hint>
        </mat-form-field>

        <mat-slider
          class="weight-slider"
          [(ngModel)]="currentWeight"
          min="0"
          max="100"
          step="0.1"
          thumbLabel="true">
        </mat-slider>
      </div>
    </mat-card-content>
    <mat-card-actions align="end">
      <button mat-button (click)="closeDialog()">取消</button>
      <button
        mat-raised-button
        color="primary"
        (click)="addFund()"
        [disabled]="!selectedFundId || currentWeight <= 0">
        添加
      </button>
    </mat-card-actions>
  </mat-card>
</div>